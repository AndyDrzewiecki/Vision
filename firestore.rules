rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Deny everything by default ──────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }

    // ── users/{uid} ─────────────────────────────────────────────────────
    // Owner-only read/write.  The document ID equals the Firebase Auth UID.
    match /users/{uid} {
      allow read, update: if request.auth != null
                          && request.auth.uid == uid;

      // Create only if the caller IS that uid (first login).
      allow create: if request.auth != null
                    && request.auth.uid == uid;

      // Users cannot delete their own account doc via client SDK.
      allow delete: if false;
    }

    // ── clips/{clipId} ──────────────────────────────────────────────────
    match /clips/{clipId} {

      // Owner can do anything.
      function isOwner() {
        return request.auth != null
            && request.auth.uid == resource.data.ownerId;
      }

      // Shared-link read: the clip has an active (non-revoked) share token
      // and the caller supplies the matching token as a custom claim or
      // through a callable/Cloud-Function wrapper.
      //
      // For MVP without Cloud Functions we allow any authenticated user to
      // read IF the share token is active.  The app enforces the token
      // match at the UI layer.  This is a pragmatic v1 trade-off —
      // Phase 5 tightens this with a Cloud Function or custom claims.
      function hasActiveShareToken() {
        return resource.data.share.token != null
            && resource.data.share.revokedAt == null;
      }

      allow read: if isOwner()
                  || hasActiveShareToken();

      allow create: if request.auth != null
                    && request.resource.data.ownerId == request.auth.uid;

      allow update, delete: if isOwner();

      // ── annotations subcollection ───────────────────────────────────
      match /annotations/{annotationId} {
        // Only the clip owner may read or write annotations.
        allow read, write: if request.auth != null
                           && get(/databases/$(database)/documents/clips/$(clipId))
                                .data.ownerId == request.auth.uid;
      }

      // ── voiceovers subcollection (optional v1) ──────────────────────
      match /voiceovers/{voiceoverId} {
        allow read, write: if request.auth != null
                           && get(/databases/$(database)/documents/clips/$(clipId))
                                .data.ownerId == request.auth.uid;
      }
    }
  }
}
